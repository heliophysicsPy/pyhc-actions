# action.yml
name: "PHEP 3 Compliance Checker"
description: "Check package compliance with PHEP 3 (Python/package version support policy)"
author: PyHC Community

branding:
  icon: "check-square"
  color: "blue"

inputs:
  project-file:
    description: "Path to pyproject.toml file"
    required: false
    default: "pyproject.toml"
  fail-on-warning:
    description: "Treat warnings as errors"
    required: false
    default: "false"
  check-adoption:
    description: "Check 6-month adoption rule for new versions"
    required: false
    default: "true"
  schedule-path:
    description: "Path to schedule.json file (optional, will download if missing)"
    required: false
    default: ""
  use-uv-fallback:
    description: "Use uv for metadata extraction from legacy formats (setup.py, Poetry)"
    required: false
    default: "true"
  ignore-errors-for:
    description: "Comma-separated list of package names to treat errors as warnings"
    required: false
    default: ""

outputs:
  passed:
    description: "Whether the check passed"
    value: ${{ steps.check.outputs.passed }}
  errors:
    description: "Number of errors found"
    value: ${{ steps.check.outputs.errors }}
  warnings:
    description: "Number of warnings found"
    value: ${{ steps.check.outputs.warnings }}

runs:
  using: "composite"
  steps:
    - name: Download schedule.json
      if: ${{ inputs.schedule-path == '' }}
      shell: bash
      run: |
        # Try to download from PyHC releases, fall back to generating
        SCHEDULE_URL="https://github.com/heliophysicsPy/pyhc-actions/releases/latest/download/schedule.json"
        if curl -fsSL "$SCHEDULE_URL" -o "${{ github.action_path }}/../schedule.json" 2>/dev/null; then
          echo "Downloaded schedule.json from releases"
        else
          echo "Could not download schedule.json, will use built-in Python schedule"
        fi

    - name: Compute minimum PHEP 3 Python version
      id: python-version
      shell: bash
      run: |
        # Determine which schedule file to use
        SCHEDULE_FILE=""
        if [ -n "${{ inputs.schedule-path }}" ]; then
          SCHEDULE_FILE="${{ inputs.schedule-path }}"
        elif [ -f "${{ github.action_path }}/../schedule.json" ]; then
          SCHEDULE_FILE="${{ github.action_path }}/../schedule.json"
        fi

        if [ -n "$SCHEDULE_FILE" ] && [ -f "$SCHEDULE_FILE" ]; then
          # Extract minimum Python version from schedule.json
          MIN_PYTHON=$(python3 "${{ github.action_path }}/get_min_python.py" "$SCHEDULE_FILE" 2>/dev/null || echo "3.12")
        else
          MIN_PYTHON="3.12"
        fi

        echo "Using Python $MIN_PYTHON (minimum PHEP 3 supported version)"
        echo "version=$MIN_PYTHON" >> "$GITHUB_OUTPUT"

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ steps.python-version.outputs.version }}

    - name: Install uv
      if: ${{ inputs.use-uv-fallback == 'true' }}
      shell: bash
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Install dependencies
      shell: bash
      run: |
        python -m pip install --upgrade pip
        pip install packaging tomlkit requests

    - name: Run PHEP 3 compliance check
      id: check
      shell: bash
      env:
        PYTHONPATH: ${{ github.action_path }}/../src
      run: |
        CHECK_ARGS=()
        if [ -n "${{ inputs.schedule-path }}" ]; then
          CHECK_ARGS+=(--schedule "${{ inputs.schedule-path }}")
        elif [ -f "${{ github.action_path }}/../schedule.json" ]; then
          CHECK_ARGS+=(--schedule "${{ github.action_path }}/../schedule.json")
        fi

        if [ "${{ inputs.fail-on-warning }}" = "true" ]; then
          CHECK_ARGS+=(--fail-on-warning)
        fi
        if [ "${{ inputs.check-adoption }}" = "false" ]; then
          CHECK_ARGS+=(--no-adoption-check)
        fi
        if [ "${{ inputs.use-uv-fallback }}" = "false" ]; then
          CHECK_ARGS+=(--no-uv-fallback)
        fi
        if [ -n "${{ inputs.ignore-errors-for }}" ]; then
          CHECK_ARGS+=(--ignore-errors-for "${{ inputs.ignore-errors-for }}")
        fi

        CHECK_ARGS+=("${{ inputs.project-file }}")
        python -m pyhc_actions.phep3.main "${CHECK_ARGS[@]}"
        EXIT_CODE=$?

        if [ $EXIT_CODE -eq 0 ]; then
          echo "passed=true" >> "$GITHUB_OUTPUT"
        else
          echo "passed=false" >> "$GITHUB_OUTPUT"
        fi

        exit $EXIT_CODE
